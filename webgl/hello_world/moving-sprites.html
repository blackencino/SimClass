
<!DOCTYPE html>

<!--
   Using the fast sprite renderer to display the output of a simulation.
-->

<html>
<head>
<meta charset="UTF-8">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<title>Sprite Drawing of Simulation Data WebGL</title>
<style>
    label {
        margin-left: 30px;
    }
</style>
</head>

<body>

<h2>Moving Sprites with the WebGL drawArraysInstanced primitive</h2>

<noscript><p><b>Sorry, but this page requires JavaScript.</b></p></noscript>

<p>
    <label><b><input type="checkbox" id="animateCheckbox">&nbsp;Animate</b></label>
    <label><b><input type="checkbox" id="colorCheckbox">&nbsp;Random&nbsp;Colors</b></label>
    <label><b>Point Size:</b>&nbsp;<select id="sizeChoice">
        <option value="0.5">Small</option>
        <option value="1.0">Medium</option>
        <option value="2.0">Large</option>
    </select></label>
</p>

<div id="canvas-holder">
<canvas id="webglcanvas" width="800" height="600"></canvas>
</div>

<textarea id="user_forces_text_area">
This will be where the code goes;
for user forces;
</textarea>


<script type="module">
import {Simple_simulation} from "./simulation.js";
import {get_gl_context_bundle, Simple_simulation_renderer} from "./sprite_renderer.js";

"use strict";
//------------------------------------------------------------------------------
// Initialize the program.
// This function is called after the page has been loaded.
function init() {
    var canvas;
    var gl_context_bundle;
    var simulation;
    var simulation_renderer;
    try {
        canvas = document.getElementById("webglcanvas");
        gl_context_bundle = get_gl_context_bundle(canvas);
    } catch (e) {
        document.getElementById("canvas-holder").innerHTML =
            "<p>Sorry, could not get a WebGL graphics context.</p>";
        return;
    }

    simulation = new Simple_simulation({
        count: 1000,
        support: 15.0,
        width: canvas.width,
        height: canvas.height,
    });

    try {
        simulation_renderer = new Simple_simulation_renderer(
            gl_context_bundle,
            simulation
        );
    } catch (e) {
        document.getElementById("canvas-holder").innerHTML =
            "<p>Sorry, could not initialize the WebGL graphics context:" +
            e +
            "</p>";
        return;
    }

    var animate_checkbox = document.getElementById("animateCheckbox");
    var color_checkbox = document.getElementById("colorCheckbox");
    var size_choice = document.getElementById("sizeChoice");
    var animating = true;

    animate_checkbox.checked = true;
    color_checkbox.checked = true;
    size_choice.value = "1.0";

    var prev_time = performance.now();
    var do_frame = function(new_time) {
        if (new_time > prev_time) {
            const delta_time = new_time - prev_time;
            prev_time = new_time;
            const delta_time_seconds = Math.min(3.0, 0.001 * delta_time);
            simulation.step(delta_time_seconds);
            simulation_renderer.update_buffers(simulation);
        }

        simulation_renderer.render({
            do_array_colors: Boolean(color_checkbox.checked),
            point_size_gain: Number(size_choice.value),
            width: canvas.width,
            height: canvas.height,
        });

        if (Boolean(animate_checkbox.checked)) {
            requestAnimationFrame(do_frame);
        }
    };

    var regular_change = () => {
        if (!animate_checkbox.checked) {
            prev_time = performance.now();
            do_frame(prev_time);
        }
    };

    color_checkbox.onchange = regular_change;
    size_choice.onchange = regular_change;

    animate_checkbox.onchange = () => {
        if (animate_checkbox.checked) {
            prev_time = performance.now();
            do_frame(prev_time);
        }
    };

    prev_time = performance.now();
    do_frame(prev_time);
}

init();
</script>

</body>
</html>
